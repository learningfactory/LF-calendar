<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar OAuth 연동</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@5.11.3/main.global.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script> <!-- Google OAuth -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
</head>
<body>
    <h2>📅 내 캘린더</h2>
    <button id="authorize_button">Google 로그인</button>
    <button id="signout_button" style="display:none;">로그아웃</button>
    <div id="calendar"></div>

    <script>
        let CLIENT_ID = "236715550382-tq8n97cch62bo3jcvuflmij6rj3ab0qp.apps.googleusercontent.com"; // OAuth 클라이언트 ID
        let API_KEY = "AIzaSyAUU-C7wQhYfOYaGbm4VdhJ6kKqgeru4MM"; // API 키
        let SCOPES = "https://www.googleapis.com/auth/calendar.readonly"; // 읽기 권한

        let authorizeButton, signoutButton, calendarEl, calendar;

        function loadGapi() {
            console.log("🔄 gapi 스크립트 로드 중...");
            let script = document.createElement("script");
            script.src = "https://apis.google.com/js/api.js";
            script.async = true;
            script.defer = true;
            script.onload = function () {
                console.log("✅ gapi 스크립트 로드 완료!");
                gapi.load("client:auth2", initClient);
            };
            document.body.appendChild(script);
        }

        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
                scope: SCOPES
            }).then(() => {
                console.log("✅ Google API 클라이언트 초기화 완료");
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            }).catch(error => console.error("❌ gapi.client.init 오류:", error));
        }

        function handleAuthClick() {
            gapi.auth2.getAuthInstance().signIn();
        }

        function handleSignoutClick() {
            gapi.auth2.getAuthInstance().signOut();
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authorizeButton.style.display = "none";
                signoutButton.style.display = "block";
                loadCalendar();
            } else {
                authorizeButton.style.display = "block";
                signoutButton.style.display = "none";
            }
        }

        function loadCalendar() {
            if (calendar) {
                calendar.destroy();
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                slotMinTime: '09:00:00',
                slotMaxTime: '18:00:00',
                events: fetchGoogleCalendarEvents
            });

            calendar.render();
        }

        function fetchGoogleCalendarEvents(info, successCallback, failureCallback) {
            gapi.client.calendar.events.list({
                calendarId: "primary",
                timeMin: (new Date()).toISOString(),
                showDeleted: false,
                singleEvents: true,
                maxResults: 50,
                orderBy: "startTime"
            }).then(response => {
                let events = response.result.items.map(event => ({
                    title: event.summary,
                    start: event.start.dateTime || event.start.date,
                    end: event.end.dateTime || event.end.date
                }));
                successCallback(events);
            }).catch(error => {
                console.error("❌ Google Calendar API 오류:", error);
                failureCallback(error);
            });
        }

        window.onload = function () {
            console.log("🔄 페이지 로드 완료, gapi 로드 시작");
            loadGapi();
        };
    </script>
</body>
</html>
